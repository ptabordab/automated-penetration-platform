const axios = require('axios');
import * as log4js from 'log4js';

export const runVulnerabilityScan = async (ipAddress: string, token: string, config:any  ) => {

    const logger = log4js.getLogger("runVulnerabilityScan");

    try 
    {
        const response = await axios.post(`${config.nessusUrl}/scans`,
            {
                uuid: config.nessusScanTemplateUUID, // Replace with the UUID of your scan template
                targets: ipAddress // Replace with the target IP or range
            },
            {
                headers: {
                'X-API-Token': `${config.nessusApiKey}:${config.nessusApiTokenapiToken}`,
                'X-Cookie': `token=${token}`
                }
            }
        );
    
        const { scan } = response.data;

        logger.debug(`Scan Response: ${scan}`);

        return scan;

    } 
    catch (error: any) 
    {
        logger.error('Failed to initiate scan:', error.response.data.error);
        throw error;
    }

}
